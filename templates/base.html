<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}PlasmoBlood Sync{% endblock %}</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS and Lucide Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#ef4444',
            dark: '#111827',
            lightDark: '#1f2937',
            accent: '#3b82f6',
            muted: '#6b7280',
            card: '#1e293b'
          },
          fontFamily: {
            sans: ['Inter', 'Poppins', 'sans-serif']
          }
        }
      }
    };
  </script>

  <style>
    body {
      transition: background-color 0.3s, color 0.3s;
    }
  </style>
</head>
<body class="bg-white dark:bg-dark text-black dark:text-white min-h-screen font-sans transition-all duration-300">
  <div class="flex">
    <!-- Sidebar -->
    <aside class="w-64 min-h-screen bg-gray-100 dark:bg-lightDark text-black dark:text-white shadow-lg border-r border-gray-300 dark:border-gray-700 hidden md:block text-sm">
      <div class="px-6 py-4 text-4xl text-center">
        <span id="emojiLogo">🩸</span>
      </div>
      <nav class="mt-6 space-y-2 font-medium">
        {% if session.get('role') == 'admin' %}
<a href="{{ url_for('admin_home') }}" class="{% if request.path == '/admin-home' %}bg-slate-700{% endif %} flex items-center gap-2 text-white hover:bg-slate-700 px-4 py-3 rounded-lg">
  <i data-lucide="home"></i> Home
</a>
{% else %}
<a href="{{ url_for('home') }}" class="{% if request.path == '/' %}bg-slate-700{% endif %} flex items-center gap-2 text-white hover:bg-slate-700 px-4 py-3 rounded-lg">
  <i data-lucide="home"></i> Home
</a>
{% endif %}



        {% if session.get('role') != 'admin' %}
        <a href="/register" class="flex items-center px-6 py-3 transition {{ 'bg-gray-200 dark:bg-gray-700 font-bold rounded-xl' if request.path == '/register' else 'hover:bg-gray-200 dark:hover:bg-gray-700' }}">
          <i data-lucide="heart-handshake" class="w-5 h-5 mr-3"></i> Donate
        </a>
        {% endif %}
        {% if session.get('role') != 'user' %}
        <a href="/request-blood" class="flex items-center px-6 py-3 transition {{ 'bg-gray-200 dark:bg-gray-700 font-bold rounded-xl' if request.path == '/request-blood' else 'hover:bg-gray-200 dark:hover:bg-gray-700' }}">
          <i data-lucide="droplet" class="w-5 h-5 mr-3"></i> Request
        </a>
        {% endif %}
        <a href="/eligibility" class="flex items-center px-6 py-3 transition {{ 'bg-gray-200 dark:bg-gray-700 font-bold rounded-xl' if request.path == '/eligibility' else 'hover:bg-gray-200 dark:hover:bg-gray-700' }}">
          <i data-lucide="check-circle" class="w-5 h-5 mr-3"></i> Eligibility
        </a>
        <a href="/admin" class="flex items-center px-6 py-3 transition {{ 'bg-gray-200 dark:bg-gray-700 font-bold rounded-xl' if request.path == '/dashboard' else 'hover:bg-gray-200 dark:hover:bg-gray-700' }}">
          <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
        </a>
      </nav>
    </aside>

    <!-- Page Content -->
    <div class="flex-1">
      <!-- Navbar -->
      <nav class="flex items-center justify-between px-8 py-4 bg-gray-100 dark:bg-lightDark shadow-md text-sm font-medium tracking-wide">
        <div class="flex items-center space-x-4">
          <button id="themeToggle" class="text-yellow-500 dark:text-yellow-300">
            <i data-lucide="moon"></i>
          </button>
          <span class="font-bold text-primary dark:text-red-600 font-poppins">
            PlasmoBlood Sync
          </span>
        </div>
        <div class="relative">
          {% if session.get('email') %}
            {% set name = session.get('username', 'User') %}
            {% set initials = name[0:1].upper() + (name.split(' ')[1][0:1].upper() if ' ' in name else '') %}
            {% set colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-yellow-500'] %}
            {% set color = colors[loop.index0 % colors|length] if loop else 'bg-gray-500' %}

            <button id="accountBtn" class="flex items-center gap-3 px-3 py-2 rounded-full bg-gray-200 dark:bg-white text-gray-800 font-semibold shadow hover:bg-gray-300 transition">
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold {{ color }}">
                {{ initials }}
              </div>
              <svg id="dropdownArrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div id="accountDropdown" class="hidden absolute right-0 mt-3 w-52 bg-white dark:bg-lightDark border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg z-50 text-sm">
              <div class="px-4 py-3 border-b border-gray-300 dark:border-gray-700 font-medium text-black dark:text-white">
                {{ session['username'] }}
              </div>
              <div class="relative">
  <button id="myAccountBtn" class="block w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700">My Account</button>
  <div id="myAccountMenu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-lightDark border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg z-50 text-sm">
    <a href="/edit-profile" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">✏️ Edit Profile</a>
    <a href="/signin" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">🔄 Switch Account</a>
    <a href="/signout" class="block px-4 py-2 text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700">🚪 Sign Out</a>
  </div>
</div>


              <a href="/settings" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">⚙️ Settings</a>
              <a href="/signout" class="block px-4 py-2 text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700">🚪 Sign Out</a>
            </div>
          {% else %}
           <a href="/signin" class="px-4 py-2 bg-primary text-white rounded-full font-semibold hover:bg-red-500 transition">Sign In</a>
          {% endif %}
        </div>

      </nav>

      <!-- Toggle Buttons -->
      <div class="bg-gray-100 dark:bg-card px-6 py-3 flex items-center justify-center gap-8 border-b border-accent text-sm font-semibold tracking-wide shadow no-replace">
        <button id="toggleBlood" class="px-4 py-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition">Blood</button>
        <button id="togglePlasma" class="px-4 py-2 rounded-full bg-purple-200 text-gray-900 hover:bg-purple-300 transition">Plasma</button>
      </div>

      <!-- Main Content -->
      <main class="p-8 pt-12 leading-relaxed tracking-wide text-base space-y-16">

        <!-- 🔵 Welcome Alert Box -->
        {% if session.get('email') and session.get('role') == 'user' and request.path == '/' %}
        <div class="max-w-4xl mx-auto mb-8 animate-fade-in-down">
        <div class="flex items-center gap-4 px-6 py-5 bg-gradient-to-r from-blue-800 to-indigo-800 text-white rounded-xl shadow-lg border border-blue-400/30">
        <div class="text-3xl">👋</div>
        <div>
          <h2 class="text-xl font-bold leading-tight tracking-wide">Welcome back, {{ session['username'] | capitalize }}!</h2>
          <p class="text-sm text-blue-100 mt-1">We're glad to see you again. Let’s save more lives together!</p>
        </div>
        </div>
        </div>
{% endif %}

        <!-- 📋 User Questionnaire -->
        {% if session.get('email') and session.get('role') == 'user' and request.path == '/' %}
        <div class="flex flex-col items-center justify-center pt-12 pb-16 px-4 space-y-6 bg-amber-100 dark:bg-slate-800 rounded-xl shadow-md mx-auto max-w-2xl">
          <h2 class="text-3xl font-extrabold text-center text-accent dark:text-yellow-400 tracking-wide">📋 User Questionnaire</h2>
          <p class="text-center text-sm text-muted dark:text-gray-400 max-w-lg">We value your feedback. Click the button below to share your experience and help us improve the platform.</p>
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSdZsD-2lHlB2nfMRbw-_rNnvZe4yUheWjh6lM4HkN4_jTj16A/viewform"
             target="_blank"
             class="inline-flex items-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-primary to-red-600 hover:from-red-500 hover:to-red-700 rounded-full shadow-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Fill Out Questionnaire
          </a>
        </div>
        {% endif %}
        

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- JS Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById("themeToggle");
      const accountBtn = document.getElementById("accountBtn");
      const accountDropdown = document.getElementById("accountDropdown");
      const dropdownArrow = document.getElementById("dropdownArrow");
      const toggleBlood = document.getElementById("toggleBlood");
      const togglePlasma = document.getElementById("togglePlasma");

      accountBtn?.addEventListener("click", () => {
        accountDropdown?.classList.toggle("hidden");
        dropdownArrow?.classList.toggle("rotate-180");
      });

      document.addEventListener("click", (e) => {
        if (!accountBtn?.contains(e.target) && !accountDropdown?.contains(e.target)) {
          accountDropdown?.classList.add("hidden");
          dropdownArrow?.classList.remove("rotate-180");
        }
      });
      const myAccountBtn = document.getElementById("myAccountBtn");
const myAccountMenu = document.getElementById("myAccountMenu");

myAccountBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  myAccountMenu.classList.toggle("hidden");
});

// Close on outside click
document.addEventListener("click", (e) => {
  if (!myAccountMenu.contains(e.target) && !myAccountBtn.contains(e.target)) {
    myAccountMenu.classList.add("hidden");
  }
});


      themeToggle?.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
      });

      const storedTheme = localStorage.getItem("theme");
      if (storedTheme === "light") document.documentElement.classList.remove("dark");
      else document.documentElement.classList.add("dark");

      let currentType = 'Blood';
      function walkDOMAndReplace(node, fromText, toText) {
        if (node.nodeType === 3 && !node.parentElement.closest('.no-replace')) {
          if (node.textContent.includes(fromText)) {
            node.textContent = node.textContent.replaceAll(fromText, toText);
          }
        } else {
          node.childNodes.forEach(child => walkDOMAndReplace(child, fromText, toText));
        }
      }

      function switchType(toType) {
        if (currentType === toType) return;
        walkDOMAndReplace(document.body, currentType, toType);
        document.title = document.title.replace(currentType, toType);
        document.getElementById("emojiLogo").textContent = toType === "Plasma" ? "⚡" : "🩸";
        toggleBlood.classList.toggle("bg-red-500", toType === "Blood");
        togglePlasma.classList.toggle("bg-purple-200", toType === "Plasma");
        currentType = toType;
      }

      toggleBlood?.addEventListener("click", () => {
        switchType("Blood");
        localStorage.setItem("donationType", "Blood");
      });

      togglePlasma?.addEventListener("click", () => {
        switchType("Plasma");
        localStorage.setItem("donationType", "Plasma");
      });

      const savedType = localStorage.getItem("donationType");
      if (savedType && savedType !== "Blood") switchType(savedType);

      lucide.createIcons();
    });
    <script>
document.addEventListener("DOMContentLoaded", () => {
  async function updateUserLocation() {
    if (!navigator.geolocation) {
      console.warn("Geolocation not supported by browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const { latitude, longitude } = pos.coords;
        console.log("📍 Sending location:", latitude, longitude);

        try {
          const res = await fetch("/update_location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: latitude, lng: longitude })
          });

          const data = await res.json();
          console.log("✅ Location update:", data);
        } catch (err) {
          console.error("❌ Failed to send location:", err);
        }
      },
      (err) => {
        console.error("Location error:", err);
        alert("Please allow location access to continue.");
      }
    );
  }

  const user = localStorage.getItem("user");
  if (user) updateUserLocation();
});
</script>

  </script>
</body>
</html>
