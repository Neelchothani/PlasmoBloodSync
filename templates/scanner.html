<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blood Request Scanner</title>
<style>
body { 
    text-align: center; 
    font-family: sans-serif; 
    background: #f0f0f0; 
    color: #000; 
}
#radar { 
    width: 300px; 
    height: 300px; 
    border-radius: 50%; 
    margin: 50px auto; 
    border: 5px solid #00bfff; 
    position: relative; 
    overflow: hidden; 
}
.pulse { 
    width: 100%; 
    height: 100%; 
    border-radius: 50%; 
    background: rgba(0,191,255,0.2); 
    position: absolute; 
    top: 0; 
    left: 0; 
    animation: pulse 2s infinite; 
}
@keyframes pulse { 
    0% {transform: scale(0.5); opacity: 0.7} 
    50% {transform: scale(1); opacity: 0.3} 
    100% {transform: scale(0.5); opacity: 0.7} 
}
#donorInfo { 
    margin-top: 20px; 
    font-size: 18px; 
    color: #000; 
}
#donorInfo h3 { color: #000; }
#donorInfo p { color: #000; }
#nearbyList { margin-top: 20px; text-align: left; max-width: 400px; margin-left:auto; margin-right:auto; }
#nearbyList div { padding: 6px 0; border-bottom: 1px solid #ccc; }
</style>
</head>
<body>
<h2>Searching for Donors...</h2>
<div id="radar"><div class="pulse"></div></div>
<audio id="alertSound" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
<div id="donorInfo"></div>
<div id="nearbyList"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const requestId = "{{ request_id }}";  // passed from Flask
const donorInfoDiv = document.getElementById("donorInfo");
const nearbyListDiv = document.getElementById("nearbyList");
const alertSound = document.getElementById("alertSound");

const acceptedDonor = {{ accepted_donor | default({}) | tojson }};
const requestedGroup = "{{ request.blood_group }}"; // Requested group from Flask

// Show donor info & play sound
function showDonorInfo(donor) {
    donorInfoDiv.innerHTML = `
        <h3>Donor Found!</h3>
        <p>Name: ${donor.name}</p>
        <p>Blood/Plasma Group Needed: ${requestedGroup}</p>
    `;
    alertSound.play();
    document.body.style.background = "#d4edda";
    document.querySelector("#radar .pulse").style.background = "rgba(0,200,0,0.4)";
}

// Display nearby donors list with Accept button
function displayNearbyUsers(users){
    nearbyListDiv.innerHTML = users.map(u => `
        <div>
            ${u.name} (${u.distance} km away)
            <button onclick="acceptRequest('${u.id}')">Accept</button>
        </div>
    `).join("");
}

// Accept request via API
async function acceptRequest(userId){
    const res = await fetch(`/accept-request-api/${requestId}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({user_id: userId})
    });
    const data = await res.json();
    if(data.status === "success"){
        showDonorInfo({name: data.accepted_user});
    }
}

// Scan nearby users using admin's real-time location
function scanNearby(){
    if(!navigator.geolocation){
        alert("Geolocation not supported!");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const {latitude, longitude} = pos.coords;

        const res = await fetch("/scan_nearby_users", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({lat: latitude, lng: longitude, request_id: requestId})
        });

        const data = await res.json();
        if(data.status === "success"){
            displayNearbyUsers(data.nearby_users);
        }
    }, (err) => { console.error(err); alert("Please allow location access!"); });
}

// Initial scan on page load
document.addEventListener("DOMContentLoaded", () => {
    // If a donor is already accepted, show immediately
    if(acceptedDonor && Object.keys(acceptedDonor).length > 0){
        showDonorInfo(acceptedDonor);
    }
    scanNearby();

    // Firestore real-time listener for updates
    db.collection("blood_requests").doc(requestId)
      .onSnapshot(doc => {
          const data = doc.data();
          if(data && data.status === "accepted" && data.accepted_donor){
              showDonorInfo(data.accepted_donor);
          }
      });
});
</script>
</body>
</html>
