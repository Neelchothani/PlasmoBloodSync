<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blood Request Scanner</title>
<style>
body { 
    text-align: center; 
    font-family: sans-serif; 
    background: #f0f0f0; 
    color: #000; 
    padding: 20px;
}
#radar { 
    width: 300px; 
    height: 300px; 
    border-radius: 50%; 
    margin: 50px auto; 
    border: 5px solid #00bfff; 
    position: relative; 
    overflow: hidden; 
}
.pulse { 
    width: 100%; 
    height: 100%; 
    border-radius: 50%; 
    background: rgba(0,191,255,0.2); 
    position: absolute; 
    top: 0; 
    left: 0; 
    animation: pulse 2s infinite; 
}
@keyframes pulse { 
    0% {transform: scale(0.5); opacity: 0.7} 
    50% {transform: scale(1); opacity: 0.3} 
    100% {transform: scale(0.5); opacity: 0.7} 
}
#donorInfo { 
    margin-top: 20px; 
    font-size: 18px; 
    color: #000;
    padding: 20px;
    background: white;
    border-radius: 5px;
    display: none;
}
#donorInfo.show { 
    display: block;
}
#donorInfo h3 { color: #28a745; }
#donorInfo p { color: #333; margin: 8px 0; }
#nearbyList { 
    margin-top: 20px; 
    text-align: left; 
    max-width: 500px; 
    margin-left: auto; 
    margin-right: auto; 
}
#nearbyList div { 
    padding: 12px; 
    border: 1px solid #ddd; 
    margin: 8px 0;
    border-radius: 5px;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#nearbyList button {
    padding: 8px 15px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}
#nearbyList button:hover {
    background: #218838;
}
.loading {
    color: #666;
    font-size: 16px;
}
</style>
</head>
<body>
<h2>Searching for Donors...</h2>
<div id="radar"><div class="pulse"></div></div>
<audio id="alertSound" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>

<div id="donorInfo"></div>
<div id="nearbyList"></div>
<div id="loading" class="loading">Scanning for nearby donors...</div>

<script>
const requestId = "{{ request_id }}";
const donorInfoDiv = document.getElementById("donorInfo");
const nearbyListDiv = document.getElementById("nearbyList");
const loadingDiv = document.getElementById("loading");
const alertSound = document.getElementById("alertSound");

// Show donor info when someone accepts
function showDonorInfo(donor) {
    donorInfoDiv.innerHTML = `
        <h3>âœ… Donor Accepted Your Request!</h3>
        <p><strong>Donor Name:</strong> ${donor.name || 'N/A'}</p>
        <p><strong>Email:</strong> ${donor.email || 'N/A'}</p>
        <p><strong>Phone:</strong> ${donor.phone || 'N/A'}</p>
        <p style="margin-top: 15px; color: #666;">A confirmation email has been sent to the donor.</p>
    `;
    donorInfoDiv.classList.add("show");
    loadingDiv.style.display = "none";
    nearbyListDiv.innerHTML = "";
    alertSound.play();
    document.body.style.background = "#d4edda";
    document.querySelector("#radar .pulse").style.background = "rgba(0,200,0,0.4)";
}

// Display nearby donors list
function displayNearbyUsers(users){
    loadingDiv.style.display = "none";
    if(users.length === 0) {
        nearbyListDiv.innerHTML = "<p style='color: #666;'>No donors found within 10km</p>";
        return;
    }
    nearbyListDiv.innerHTML = users.map(u => `
        <div>
            <span>${u.name} (${u.distance} km away)</span>
            <button onclick="acceptRequest('${u.id}')">Accept</button>
        </div>
    `).join("");
}

// Accept request via API
async function acceptRequest(userId){
    const res = await fetch(`/accept-request-api/${requestId}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({user_id: userId})
    });
    const data = await res.json();
    if(data.status === "success"){
        showDonorInfo({name: data.accepted_user});
    } else {
        alert("Error: " + data.message);
    }
}

// Scan nearby users using admin's real-time location
function scanNearby(){
    if(!navigator.geolocation){
        alert("Geolocation not supported!");
        loadingDiv.style.display = "none";
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const {latitude, longitude} = pos.coords;

        try {
            const res = await fetch("/scan_nearby_users", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({lat: latitude, lng: longitude, request_id: requestId})
            });

            const data = await res.json();
            if(data.status === "success"){
                displayNearbyUsers(data.nearby_users);
            } else {
                loadingDiv.innerHTML = "Error: " + (data.message || "Unknown error");
            }
        } catch(err) {
            console.error(err);
            loadingDiv.innerHTML = "Error scanning for donors. Please try again.";
        }
    }, (err) => { 
        console.error(err); 
        loadingDiv.innerHTML = "Please enable location access to find donors";
    });
}

// Check if donor already accepted (polling or real-time)
async function checkForAcceptedDonor() {
    try {
        const res = await fetch(`/get_request/${requestId}`);
        const data = await res.json();
        
        if(data.status === "success" && data.request.status === "accepted") {
            showDonorInfo(data.request.accepted_donor);
            return true;
        }
    } catch(err) {
        console.error("Error checking request status:", err);
    }
    return false;
}

// Initialize on page load
document.addEventListener("DOMContentLoaded", async () => {
    // Check if already accepted
    const alreadyAccepted = await checkForAcceptedDonor();
    
    if(!alreadyAccepted) {
        // Start scanning for donors
        scanNearby();
        
        // Poll every 5 seconds for acceptance
        setInterval(checkForAcceptedDonor, 5000);
    }
});
</script>
</body>
</html>